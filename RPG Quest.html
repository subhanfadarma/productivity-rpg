<!DOCTYPE html>
<html lang="id">
<head>
<link rel="manifest" href="manifest.json">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Productivity RPG ‚Äî Dark (v2)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Rubik:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --bg:#0b0f17;
    --panel:#0f1720;
    --muted:#9aa6b2;
    --text:#e6f2f6;
    --accent1:#1fb6ff;
    --accent2:#23d199;
    --gold:#ffd166;
    --danger:#ff6b6b;
    --glass: rgba(255,255,255,0.02);
    --shadow: 0 10px 30px rgba(2,6,23,0.6);
    --radius: 12px;
    font-family: "Inter","Rubik",system-ui,-apple-system,"Segoe UI",Roboto,Arial;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#06080c 0%, var(--bg) 100%);color:var(--text)}
  .wrap{max-width:1100px;margin:18px auto;padding:18px}
  header{display:flex;gap:16px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--accent1),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:800;color:#021;box-shadow:var(--shadow)}
  .title{font-weight:700;font-size:16px}
  .subtitle{font-size:12px;color:var(--muted)}
  .hud{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.007));padding:12px;border-radius:var(--radius);min-width:160px;box-shadow:var(--shadow);border:1px solid rgba(255,255,255,0.02)}
  .label{font-size:12px;color:var(--muted)}
  .value{font-weight:800;font-size:18px;margin-top:6px;color:var(--text)}
  .level-title{font-size:13px;color:var(--accent2);font-weight:700}
  .xp-wrap{min-width:260px}
  .xp-bar{height:14px;background:rgba(255,255,255,0.02);border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,0.02)}
  .xp-fill{height:100%;width:0%;background:linear-gradient(90deg,var(--accent1),var(--accent2));transition:width .6s cubic-bezier(.2,.9,.2,1)}
  .xp-text{font-size:12px;color:var(--muted);margin-top:6px}
  main{margin-top:18px;display:grid;grid-template-columns:1fr 380px;gap:18px}
  .panel{background:var(--panel);padding:14px;border-radius:12px;min-height:220px;box-shadow:var(--shadow);border:1px solid rgba(255,255,255,0.02)}
  .tabs{display:flex;gap:8px;margin-bottom:12px}
  .tab{padding:8px 12px;border-radius:999px;background:transparent;border:1px solid rgba(255,255,255,0.03);cursor:pointer;font-weight:700;color:var(--text)}
  .tab.active{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#021}
  .quest-list{display:flex;flex-direction:column;gap:10px}
  .quest{display:flex;gap:12px;align-items:center;padding:10px;border-radius:10px;background:var(--glass);position:relative;border:1px solid rgba(255,255,255,0.02)}
  .left{display:flex;gap:12px;align-items:center;flex:1}
  .q-checkbox{appearance:none;display:inline-grid;place-items:center;width:26px;height:26px;border-radius:8px;border:1.5px solid var(--accent1);background:transparent;cursor:pointer;color:#021;font-weight:800}
  .q-checkbox.checked{background:linear-gradient(90deg,var(--accent1),var(--accent2));border-color:transparent;color:#021}
  .q-title{font-weight:700;color:var(--text)}
  .q-meta{font-size:12px;color:var(--muted)}
  .q-priority{padding:6px 10px;border-radius:10px;font-weight:700;font-size:12px}
  .prio-High{background:#3a1a1a;color:#ffbdbd}
  .prio-Medium{background:#3b2a1a;color:#ffe5b3}
  .prio-Low{background:#14311f;color:#b8f0db}
  .actions{display:flex;gap:8px}
  .btn{padding:8px 10px;border-radius:10px;border:0;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#021;font-weight:800;cursor:pointer}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--accent1)}
  .small{font-size:12px;padding:6px 8px}
  
  /* PERBAIKAN: Warna input dan select */
  .field{
    padding:10px;
    border-radius:10px;
    border:1px solid rgba(255,255,255,0.03);
    background:var(--bg); /* Latar belakang gelap */
    color:var(--text); /* Warna teks terang */
  }
  .field option{
    background:var(--bg); /* Latar belakang gelap untuk pilihan */
    color:var(--text); /* Warna teks terang untuk pilihan */
  }
  .field::-webkit-calendar-picker-indicator {
    filter: invert(1); /* Untuk warna icon tanggal */
  }

  .row{display:flex;gap:8px}
  .row .field{flex:1}
  .quest-xp{position:absolute;right:12px;top:50%;transform:translateY(-50%);font-weight:900;color:var(--text);opacity:0;pointer-events:none}
  .xp-gain{color:var(--accent2);animation:xp-pop .9s forwards}
  .xp-loss{color:var(--danger);animation:xp-pop .9s forwards}
  @keyframes xp-pop{0%{transform:translateY(0) scale(1);opacity:1}100%{transform:translateY(-20px) scale(.95);opacity:0}}
  
  /* PERBAIKAN: Latar belakang modal tidak lagi transparan */
  .modal-backdrop{
    position:fixed;
    inset:0;
    background:rgba(2,8,12,0.8); /* Warna latar belakang pop-up lebih solid */
    display:flex;
    align-items:center;
    justify-content:center;
    opacity:0;
    pointer-events:none;
    transition:opacity .22s;
  }
  .modal-backdrop.show{opacity:1;pointer-events:auto}
  .modal{
    width:min(760px,94%);
    background:var(--panel); /* Warna latar belakang modal solid */
    border-radius:14px;
    padding:18px;
    border:1px solid rgba(255,255,255,0.03);
    transform:translateY(8px) scale(.985);
    opacity:0;
    transition:transform .22s,opacity .22s;
    box-shadow:var(--shadow);
  }
  .modal-backdrop.show .modal{transform:translateY(0) scale(1);opacity:1}
  .modal h3{margin:0 0 8px 0;color:var(--text)}
  .modal .meta{font-size:13px;color:var(--muted);margin-bottom:12px}
  .shop-item{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:10px;background:var(--panel);border:1px solid rgba(255,255,255,0.02);margin-bottom:10px}
  .coins{font-weight:900;color:var(--gold);font-size:18px}
  .small-muted{font-size:12px;color:var(--muted)}
  .chart-wrap{margin-top:8px;background:transparent;border-radius:8px;overflow:auto;padding-bottom:6px}
  #xpChart{ display:block; width:100% !important; height:250px !important; max-height:250px; }
  .coin-pop{animation:coin-pop .9s ease forwards}
  @keyframes coin-pop{0%{transform:translateY(0) scale(1);opacity:1}100%{transform:translateY(-12px) scale(1.03);opacity:0}}
  .coin-loss{animation:coin-loss .9s ease forwards;color:var(--danger)}
  @keyframes coin-loss{0%{transform:translateY(0) scale(1);opacity:1}100%{transform:translateY(-12px) scale(.98);opacity:0}}
  @media(max-width:980px){ main{grid-template-columns:1fr} .hud{flex-direction:column;align-items:flex-start;gap:8px} }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand" aria-hidden="false">
      <div class="logo">RPG</div>
      <div>
        <div class="title">Productivity RPG</div>
        <div class="subtitle">Dark ¬∑ Blue-Green ¬∑ Focused</div>
      </div>
    </div>

    <div class="hud" aria-hidden="false">
      <div class="card">
        <div class="label">üßÆ XP Hari Ini</div>
        <div id="xpToday" class="value">0</div>
        <div class="xp-text small-muted">XP dari tugas yang selesai hari ini</div>
      </div>

      <div class="card">
        <div class="label">üß¨ Level</div>
        <div class="value" id="levelLabel">Level 1</div>
        <div class="level-title" id="levelTitle">Pemula Bangkit</div>
      </div>

      <div class="card xp-wrap">
        <div class="label">Progress ke level berikutnya</div>
        <div class="xp-bar"><div id="xpFill" class="xp-fill"></div></div>
        <div class="xp-text" id="xpProgress">0 / 100 XP</div>
      </div>

      <div class="card">
        <div class="label">üèÖ Gold</div>
        <div id="coins" class="value coins">0</div>
        <div class="small-muted">Untuk beli item di Shop</div>
      </div>

      <div class="card">
        <div class="label" style="color:var(--accent2)">üìÖ Tanggal</div>
        <div id="todayLabel" class="value">-</div>
        <div class="small-muted" id="tzInfo"></div>
      </div>
    </div>
  </header>

  <main>
    <section class="panel" aria-label="Quests panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:800">Quests</div>
          <div class="small-muted">Daily & Weekly ‚Äî centang untuk kumpulkan XP</div>
        </div>

        <div style="display:flex;gap:8px;align-items:center">
          <button id="exportBtn" class="btn small">Export</button>
          <button id="importBtn" class="btn ghost small">Import</button>
          <button id="openShopBtn" class="btn small">Open Shop</button>
        </div>
      </div>

      <div style="margin-top:12px" class="tabs" role="tablist">
        <button class="tab active" data-tab="daily" role="tab">Daily</button>
        <button class="tab" data-tab="weekly" role="tab">Weekly</button>
        <button class="tab" data-tab="all" role="tab">All</button>
      </div>

      <div style="margin-bottom:12px" class="add-quest" aria-label="Add quest">
        <div class="row">
          <input id="qTitle" class="field" placeholder="Nama quest / tugas (contoh: Belajar 1 jam)">
          <select id="qPriority" class="field" style="max-width:160px">
            <option value="High">High (+15 XP)</option>
            <option value="Medium">Medium (+10 XP)</option>
            <option value="Low">Low (+5 XP)</option>
          </select>
        </div>
        <div class="row" style="margin-top:8px">
          <select id="qType" class="field" style="max-width:180px">
            <option value="Daily">Daily</option>
            <option value="Weekly">Weekly</option>
            <option value="Special">Special</option>
          </select>
          <input id="qDeadline" class="field" type="date" placeholder="Deadline (opsional)">
          <button id="addQuestBtn" class="btn small">Tambah Quest</button>
        </div>
      </div>

      <div class="quest-list" id="questList" aria-live="polite"></div>
    </section>

    <aside class="panel" aria-label="Shop and stats">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:800">Shop & Statistik</div>
        <div class="small-muted">Upgrade & lihat progress</div>
      </div>

      <div style="margin-top:12px">
        <div class="small-muted">Statistik XP (14 hari terakhir)</div>
        <div class="chart-wrap">
          <canvas id="xpChart" width="800" height="250"></canvas>
        </div>
      </div>

      <div style="margin-top:12px">
        <div class="small-muted">Tools</div>
        <div style="margin-top:8px;display:flex;flex-direction:column;gap:8px">
          <button id="useBoosterBtn" class="btn small">Use XP Booster (if owned)</button>
          <button id="resetDailyBtn" class="btn ghost small">Reset Daily (manual)</button>
          <button id="resetWeeklyBtn" class="btn ghost small">Reset Weekly (manual)</button>
          <button id="clearAllBtn" class="btn ghost small">Reset Semua</button>
        </div>
      </div>

      <div style="margin-top:14px">
        <div class="small-muted">Riwayat singkat</div>
        <div id="recentLog" style="margin-top:8px;font-size:13px;color:var(--muted);min-height:80px;max-height:240px;overflow:auto"></div>
      </div>
    </aside>
  </main>
</div>

<div id="modalBackdrop" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <h3 id="modalTitle">Quest Detail</h3>
    <div class="meta" id="modalMeta">‚Äî</div>

    <div style="display:flex;flex-direction:column;gap:8px">
      <textarea id="modalDesc" class="field" rows="4" placeholder="Deskripsi / catatan quest (opsional)"></textarea>
      <div class="row">
        <select id="modalType" class="field" style="max-width:160px">
          <option value="Daily">Daily</option>
          <option value="Weekly">Weekly</option>
          <option value="Special">Special</option>
        </select>
        <select id="modalPriority" class="field" style="max-width:160px">
          <option value="High">High (+15 XP)</option>
          <option value="Medium">Medium (+10 XP)</option>
          <option value="Low">Low (+5 XP)</option>
        </select>
        <input id="modalDeadline" class="field" type="date">
      </div>
    </div>

    <div class="actions">
      <div style="flex:1"></div>
      <div class="actions">
        <button id="modalDelete" class="btn ghost small">Hapus</button>
        <button id="modalCancel" class="btn ghost small">Batal</button>
        <button id="modalSave" class="btn small">Simpan</button>
      </div>
    </div>
  </div>
</div>

<div id="shopBackdrop" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" style="max-width:720px">
    <h3>üè¨ Shop ‚Äî Toko Kosmetik & Booster</h3>
    <div class="meta small-muted">Beli item untuk kustomisasi atau booster XP.</div>

    <div id="shopItems" style="margin-top:12px;display:flex;flex-direction:column;gap:8px"></div>

    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
      <div class="small-muted">Gold: <span id="shopCoins" class="coins">0</span></div>
      <div><button id="shopCloseBtn" class="btn ghost small">Tutup</button></div>
    </div>
  </div>
</div>

<script>
(() => {
  const STORAGE_KEY = 'prodRpg_dark_v2';
  const XP_PER_LEVEL = 100;
  const PRIORITY_XP = { High:15, Medium:10, Low:5 };
  const LEVEL_NAMES = ['Pemula Bangkit','Pejuang Fokus','Ksatria Konsisten','Master Produktif','Legenda Fokus'];
  const COIN_PER_XP = 1/10;
  const LEVEL_UP_GOLD = 10;
  const HISTORY_DAYS = 14;

  const xpTodayEl = document.getElementById('xpToday');
  const levelLabelEl = document.getElementById('levelLabel');
  const levelTitleEl = document.getElementById('levelTitle');
  const xpFillEl = document.getElementById('xpFill');
  const xpProgressEl = document.getElementById('xpProgress');
  const todayLabel = document.getElementById('todayLabel');
  const tzInfo = document.getElementById('tzInfo');
  const coinsEl = document.getElementById('coins');

  const questListEl = document.getElementById('questList');
  const tabs = Array.from(document.querySelectorAll('.tab'));
  const qTitle = document.getElementById('qTitle');
  const qPriority = document.getElementById('qPriority');
  const qType = document.getElementById('qType');
  const qDeadline = document.getElementById('qDeadline');
  const addQuestBtn = document.getElementById('addQuestBtn');

  const modalBackdrop = document.getElementById('modalBackdrop');
  const modalTitle = document.getElementById('modalTitle');
  const modalMeta = document.getElementById('modalMeta');
  const modalDesc = document.getElementById('modalDesc');
  const modalType = document.getElementById('modalType');
  const modalPriority = document.getElementById('modalPriority');
  const modalDeadline = document.getElementById('modalDeadline');
  const modalSave = document.getElementById('modalSave');
  const modalCancel = document.getElementById('modalCancel');
  const modalDelete = document.getElementById('modalDelete');

  const shopBackdrop = document.getElementById('shopBackdrop');
  const shopItemsEl = document.getElementById('shopItems');
  const shopCoinsEl = document.getElementById('shopCoins');
  const openShopBtn = document.getElementById('openShopBtn');
  const shopCloseBtn = document.getElementById('shopCloseBtn');
  const useBoosterBtn = document.getElementById('useBoosterBtn');

  const exportBtn = document.getElementById('exportBtn');
  const importBtn = document.getElementById('importBtn');
  const resetDailyBtn = document.getElementById('resetDailyBtn');
  const resetWeeklyBtn = document.getElementById('resetWeeklyBtn');
  const clearAllBtn = document.getElementById('clearAllBtn');
  const recentLog = document.getElementById('recentLog');
  const xpChartCanvas = document.getElementById('xpChart');

  let state = {
    totalXp:0, xpToday:0, level:1, coins:0,
    quests:[], lastDailyReset:null, lastWeeklyReset:null,
    log:[], history:[],
    shop:{ items:[
      {id:'skin-neon', name:'Neon Accent', price:30, desc:'Ubah aksen HUD', owned:false, equipped:false, effect:{accent1:'#00aaff', accent2:'#22dd99'}},
      {id:'badge-gold', name:'Badge Gold', price:20, desc:'Badge kosmetik (profil)', owned:false, equipped:false},
      {id:'xp-booster', name:'XP Booster (1 day)', price:25, desc:'Boost XP x1.5 untuk hari berikutnya', owned:0, consumable:true}
    ], boosterActiveUntil:null }
  };

  const uid = ()=> Math.random().toString(36).slice(2,9);
  const todayISO = ()=> (new Date()).toISOString().slice(0,10);
  const todayLocal = ()=> (new Date()).toLocaleDateString('id-ID', { day:'numeric', month:'long', year:'numeric' });
  const weekStartISO = (d=new Date())=>{ const date=new Date(d); const day=(date.getDay()+6)%7; date.setDate(date.getDate()-day); return date.toISOString().slice(0,10); };

  let xpChart = null;
  function renderChart(){
    const days = [];
    const labels = [];
    for(let i=HISTORY_DAYS-1;i>=0;i--){
      const d = new Date(); d.setDate(d.getDate() - i);
      const iso = d.toISOString().slice(0,10);
      days.push(iso);
      labels.push(d.toLocaleDateString('id-ID', { day:'numeric', month:'short' }));
    }
    const dataPoints = days.map(day => {
      const rec = state.history.find(h => h.date === day);
      return rec ? rec.xpGained : 0;
    });

    const ctx = xpChartCanvas.getContext('2d');
    if(xpChart) xpChart.destroy();
    xpChart = new Chart(ctx, {
      type:'bar',
      data:{ labels, datasets:[{ label:'XP per day', data: dataPoints, backgroundColor:'rgba(35,209,153,0.85)' }]},
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{legend:{display:false}},
        scales:{
          x:{ ticks:{color:'#9aa6b2'}, grid:{display:false} },
          y:{ beginAtZero:true, ticks:{color:'#9aa6b2'}, grid:{color:'rgba(255,255,255,0.03)'} }
        }
      }
    });
  }

  function load(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){
      try{
        const parsed = JSON.parse(raw);
        state = Object.assign(state, parsed);
        if(!state.shop || !Array.isArray(state.shop.items)){
          state.shop = { items:[
            {id:'skin-neon', name:'Neon Accent', price:30, desc:'Ubah aksen HUD', owned:false, equipped:false, effect:{accent1:'#00aaff', accent2:'#22dd99'}},
            {id:'badge-gold', name:'Badge Gold', price:20, desc:'Badge kosmetik (profil)', owned:false, equipped:false},
            {id:'xp-booster', name:'XP Booster (1 day)', price:25, desc:'Boost XP x1.5 untuk hari berikutnya', owned:0, consumable:true}
          ], boosterActiveUntil:null };
        }
      }catch(e){
        console.error('storage parse', e);
        localStorage.removeItem(STORAGE_KEY);
      }
    } else {
      state.quests = [
        { id: uid(), title:'Belajar 1 jam', priority:'High', type:'Daily', deadline:null, desc:'Fokus materi', completed:false, completedAt:null, xpAwarded:0, coinsAwarded:0 },
        { id: uid(), title:'Baca 30 menit', priority:'Medium', type:'Daily', deadline:null, desc:'Baca buku', completed:false, completedAt:null, xpAwarded:0, coinsAwarded:0 },
        { id: uid(), title:'Rapikan folder', priority:'Low', type:'Weekly', deadline:null, desc:'Susun file project', completed:false, completedAt:null, xpAwarded:0, coinsAwarded:0 }
      ];
      save();
    }
  }
  function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

  function pushLog(text){
    const now = new Date().toLocaleString('id-ID');
    state.log.unshift(`[${now}] ${text}`);
    if(state.log.length>300) state.log.length=300;
    save(); renderLog();
  }

  function ensureHistoryWindow(){
    const list = [];
    for(let i=HISTORY_DAYS-1;i>=0;i--){
      const d = new Date(); d.setDate(d.getDate() - i);
      const iso = d.toISOString().slice(0,10);
      list.push(iso);
    }
    const newHistory = list.map(day => {
      const rec = state.history.find(h => h.date === day);
      return { date: day, xpGained: rec ? rec.xpGained : 0 };
    });
    state.history = newHistory;
    save();
  }

  function addToHistory(delta){
    const today = todayISO();
    const rec = state.history.find(h => h.date === today);
    if(rec) rec.xpGained = Math.max(0, rec.xpGained + delta);
    else state.history.unshift({date:today, xpGained: Math.max(0, delta)});
    state.history = state.history.slice(-HISTORY_DAYS);
    save(); renderChart();
  }

  function xpForPriority(p){ return PRIORITY_XP[p] || 5; }
  function isBoosterActiveForDate(dISO){ const b = state.shop.boosterActiveUntil; if(!b) return false; return dISO <= b; }
  function effectiveXp(base){
    const today = todayISO();
    if(isBoosterActiveForDate(today)) return Math.round(base * 1.5);
    return base;
  }

  function changeXP(delta, reason){
    if(delta > 0){
      state.xpToday += delta;
      state.totalXp += delta;
      const coinGain = Math.floor(delta * COIN_PER_XP);
      if(coinGain > 0){
        state.coins += coinGain;
        sparkleCoins(coinGain);
        pushLog(`+${coinGain} Gold (from ${delta} XP)`);
      }
      addToHistory(delta);
    } else {
      state.xpToday = Math.max(0, state.xpToday + delta);
      state.totalXp = Math.max(0, state.totalXp + delta);
      addToHistory(delta);
      pushLog(`${delta} XP (${reason})`);
    }

    const prevLevel = state.level;
    state.level = Math.max(1, Math.floor(state.totalXp / XP_PER_LEVEL) + 1);
    if(state.level > prevLevel){
      state.coins += LEVEL_UP_GOLD;
      sparkleCoins(LEVEL_UP_GOLD);
      pushLog(`Level up to ${state.level}! +${LEVEL_UP_GOLD} Gold`);
      showLevelToast(state.level);
    }
    if(state.coins < 0) state.coins = 0;
    save(); renderHUD();
  }

  function renderHUD(){
    xpTodayEl.textContent = state.xpToday;
    levelLabelEl.textContent = `Level ${state.level}`;
    levelTitleEl.textContent = LEVEL_NAMES[(state.level-1)%LEVEL_NAMES.length] || LEVEL_NAMES[0];
    const xpinlevel = state.totalXp % XP_PER_LEVEL;
    xpProgressEl.textContent = `${xpinlevel} / ${XP_PER_LEVEL} XP`;
    xpFillEl.style.width = `${Math.round((xpinlevel / XP_PER_LEVEL) * 100)}%`;
    todayLabel.textContent = todayLocal();
    tzInfo.textContent = `Locale: ${Intl.DateTimeFormat().resolvedOptions().locale || 'id-ID'}`;
    coinsEl.textContent = state.coins;
    if(typeof shopCoinsEl !== 'undefined' && shopCoinsEl) shopCoinsEl.textContent = state.coins;
  }

  let activeTab = 'daily';
  function renderQuests(){
    questListEl.innerHTML = '';
    const list = state.quests.filter(q => {
      if(activeTab === 'daily') return q.type === 'Daily';
      if(activeTab === 'weekly') return q.type === 'Weekly';
      return true;
    });
    if(list.length === 0){ questListEl.innerHTML = `<div class="small-muted" style="padding:10px">Tidak ada quest di tab ini.</div>`; return; }
    list.forEach(q => {
      const xpVal = xpForPriority(q.priority);
      const el = document.createElement('div');
      el.className = 'quest';
      el.innerHTML = `
        <div class="left">
          <div class="q-checkbox ${q.completed ? 'checked' : ''}" data-id="${q.id}">${q.completed ? '‚úì' : ''}</div>
          <div style="display:flex;flex-direction:column">
            <div class="q-title" data-id="${q.id}" style="cursor:pointer">${q.title}</div>
            <div class="q-meta">${q.type}${q.deadline ? ' ‚Ä¢ due '+q.deadline : ''}${q.completed ? ' ‚Ä¢ done '+(q.completedAt? q.completedAt.split('T')[0] : '') : ''}</div>
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <div class="q-priority ${'prio-'+q.priority}">${q.priority}</div>
          <div class="quest-xp" data-id="${q.id}">+${xpVal} XP</div>
          <div class="actions">
            <button class="btn ghost small edit-btn" data-id="${q.id}">‚úèÔ∏è</button>
            <button class="btn ghost small del-btn" data-id="${q.id}">üóëÔ∏è</button>
          </div>
        </div>
      `;
      questListEl.appendChild(el);

      el.querySelector('.q-checkbox').addEventListener('click', ()=> toggleComplete(q.id, el));
      el.querySelector('.q-title').addEventListener('click', ()=> openModal(q.id));
      el.querySelector('.edit-btn').addEventListener('click', ()=> openModal(q.id));
      el.querySelector('.del-btn').addEventListener('click', ()=> {
        if(confirm('Hapus quest ini?')){
          if(q.completed){
            const xpAwarded = q.xpAwarded || xpForPriority(q.priority);
            const coinsAwarded = q.coinsAwarded || Math.floor(xpAwarded * COIN_PER_XP);
            changeXP(-xpAwarded, `delete ${q.title}`);
            adjustCoins(-coinsAwarded, `delete ${q.title}`);
          }
          state.quests = state.quests.filter(x=>x.id!==q.id);
          pushLog(`Quest dihapus: ${q.title}`);
          save(); renderQuests(); renderHUD();
        }
      });
    });
  }

  function adjustCoins(delta, reason){
    if(delta === 0) return;
    if(delta > 0){
      state.coins += delta;
      sparkleCoins(delta);
      pushLog(`+${delta} Gold (${reason || 'reward'})`);
    } else {
      state.coins = Math.max(0, state.coins + delta);
      showCoinLoss(Math.abs(delta));
      pushLog(`${delta} Gold (${reason || 'penalty'})`);
    }
    save(); renderHUD();
  }

  function toggleComplete(id, containerEl){
    const q = state.quests.find(x=>x.id===id);
    if(!q) return;
    const base = xpForPriority(q.priority);
    if(!q.completed){
      const xp = effectiveXp(base);
      const coinsG = Math.floor(xp * COIN_PER_XP);
      q.completed = true;
      q.completedAt = new Date().toISOString();
      q.xpAwarded = xp;
      q.coinsAwarded = coinsG;
      changeXP(xp, `complete ${q.title}`);
      if(coinsG > 0){ }
      const cb = containerEl.querySelector('.q-checkbox'); cb.classList.add('checked');
      const slot = containerEl.querySelector('.quest-xp'); slot.textContent = `+${xp} XP`; slot.classList.add('xp-gain'); setTimeout(()=> slot.classList.remove('xp-gain'),900);
      pushLog(`Quest diselesaikan: ${q.title} (+${xp} XP, +${coinsG}G)`);
    } else {
      const xpToRemove = q.xpAwarded !== undefined ? q.xpAwarded : base;
      const coinsToRemove = q.coinsAwarded !== undefined ? q.coinsAwarded : Math.floor(xpToRemove * COIN_PER_XP);
      changeXP(-xpToRemove, `undo ${q.title}`);
      adjustCoins(-coinsToRemove, `undo ${q.title}`);
      q.completed = false;
      q.completedAt = null;
      q.xpAwarded = 0;
      q.coinsAwarded = 0;
      const cb = containerEl.querySelector('.q-checkbox'); cb.classList.remove('checked');
      const slot = containerEl.querySelector('.quest-xp'); slot.textContent = `-${xpToRemove} XP`; slot.classList.add('xp-loss'); setTimeout(()=> slot.classList.remove('xp-loss'),900);
      pushLog(`Quest dibatalkan: ${q.title} (-${xpToRemove} XP, -${coinsToRemove}G)`);
    }
    save(); renderQuests(); renderHUD();
  }

  let modalTargetId = null;
  function openModal(id){
    modalTargetId = id; const q = state.quests.find(x=>x.id===id); if(!q) return;
    modalTitle.textContent = q.title;
    modalMeta.textContent = `${q.type} ‚Ä¢ ${q.priority} ‚Ä¢ ${q.deadline ? 'due '+q.deadline : 'no deadline'}`;
    modalDesc.value = q.desc || '';
    modalType.value = q.type || 'Daily';
    modalPriority.value = q.priority || 'Low';
    modalDeadline.value = q.deadline || '';
    modalBackdrop.classList.add('show');
  }
  function closeModal(){ modalBackdrop.classList.remove('show'); modalTargetId = null; }
  modalCancel.addEventListener('click', closeModal);
  modalBackdrop.addEventListener('click', (e)=> { if(e.target === modalBackdrop) closeModal(); });
  modalSave.addEventListener('click', ()=>{
    const q = state.quests.find(x=>x.id===modalTargetId); if(!q) return;
    q.desc = modalDesc.value.trim();
    q.type = modalType.value;
    q.priority = modalPriority.value;
    q.deadline = modalDeadline.value || null;
    q.title = modalTitle.textContent || q.title;
    save(); renderQuests(); renderHUD(); pushLog(`Quest updated: ${q.title}`); closeModal();
  });
  modalDelete.addEventListener('click', ()=>{
    if(!confirm('Hapus quest ini?')) return;
    state.quests = state.quests.filter(x=>x.id!==modalTargetId);
    save(); renderQuests(); renderHUD(); pushLog('Quest dihapus (modal)'); closeModal();
  });

  addQuestBtn.addEventListener('click', ()=>{
    const title = qTitle.value.trim();
    if(!title) return alert('Isi judul quest');
    const obj = { id: uid(), title, priority: qPriority.value, type: qType.value, deadline: qDeadline.value || null, desc:'', completed:false, completedAt:null, xpAwarded:0, coinsAwarded:0 };
    state.quests.unshift(obj);
    qTitle.value=''; qDeadline.value='';
    save(); renderQuests(); pushLog(`Quest ditambahkan: ${title}`);
  });

  tabs.forEach(t => t.addEventListener('click', ()=>{
    tabs.forEach(x=>x.classList.remove('active')); t.classList.add('active');
    activeTab = t.dataset.tab; renderQuests();
  }));

  exportBtn.addEventListener('click', ()=>{
    const data = JSON.stringify(state, null, 2);
    const blob = new Blob([data], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'prod-rpg-backup-dark-v2.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });
  importBtn.addEventListener('click', ()=>{
    const input = document.createElement('input'); input.type='file'; input.accept='application/json';
    input.addEventListener('change', ()=> {
      const f = input.files[0]; if(!f) return;
      const r = new FileReader(); r.onload = ()=> {
        try{
          const obj = JSON.parse(r.result);
          if(!obj.quests) return alert('File tidak valid');
          state = obj; save(); initAfterLoad(); renderAll(); pushLog('Data diimport'); alert('Import sukses');
        } catch(e){ alert('Gagal memparsing file'); }
      }; r.readAsText(f);
    }); input.click();
  });

  function resetDaily(){
    state.quests.forEach(q => { if(q.type === 'Daily'){ q.completed = false; q.completedAt = null; q.xpAwarded = 0; q.coinsAwarded = 0; }});
    state.xpToday = 0; state.lastDailyReset = todayISO(); save(); renderQuests(); renderHUD(); pushLog('Daily reset (manual)');
  }
  function resetWeekly(){
    state.quests.forEach(q => { if(q.type === 'Weekly'){ q.completed = false; q.completedAt = null; q.xpAwarded = 0; q.coinsAwarded = 0; }});
    state.lastWeeklyReset = weekStartISO(); save(); renderQuests(); renderHUD(); pushLog('Weekly reset (manual)');
  }
  resetDailyBtn.addEventListener('click', ()=> { if(confirm('Reset Daily sekarang?')) resetDaily(); });
  resetWeeklyBtn.addEventListener('click', ()=> { if(confirm('Reset Weekly sekarang?')) resetWeekly(); });

  clearAllBtn.addEventListener('click', ()=>{
    if(!confirm('Reset semua data (XPs, coins, quests, history)?')) return;
    state = {
      totalXp:0, xpToday:0, level:1, coins:0, quests:[], lastDailyReset:null, lastWeeklyReset:null, log:[], history:[],
      shop:{ items:[
        {id:'skin-neon', name:'Neon Accent', price:30, desc:'Ubah aksen HUD', owned:false, equipped:false, effect:{accent1:'#00aaff', accent2:'#22dd99'}},
        {id:'badge-gold', name:'Badge Gold', price:20, desc:'Badge kosmetik (profil)', owned:false, equipped:false},
        {id:'xp-booster', name:'XP Booster (1 day)', price:25, desc:'Boost XP x1.5 untuk hari berikutnya', owned:0, consumable:true}
      ], boosterActiveUntil:null }
    };
    save(); initAfterLoad(); renderAll(); pushLog('Semua data direset');
  });

  function renderLog(){ recentLog.innerHTML = state.log.slice(0,100).map(l => `<div>${l}</div>`).join(''); }

  function autoResetCheck(){
    const today = todayISO();
    const weekStart = weekStartISO();
    if(state.lastDailyReset !== today){
      state.quests.forEach(q => { if(q.type === 'Daily'){ q.completed = false; q.completedAt = null; q.xpAwarded = 0; q.coinsAwarded = 0; }});
      state.xpToday = 0;
      state.lastDailyReset = today;
      pushLog('Daily reset (auto)');
    }
    if(state.lastWeeklyReset !== weekStart){
      state.quests.forEach(q => { if(q.type === 'Weekly'){ q.completed = false; q.completedAt = null; q.xpAwarded = 0; q.coinsAwarded = 0; }});
      state.lastWeeklyReset = weekStart;
      pushLog('Weekly reset (auto)');
    }
    save();
  }

  openShopBtn.addEventListener('click', ()=> openShop());
  shopCloseBtn.addEventListener('click', ()=> closeShop());
  shopBackdrop.addEventListener('click', (e)=> { if(e.target === shopBackdrop) closeShop(); });
  function openShop(){ renderShop(); shopBackdrop.classList.add('show'); if(shopCoinsEl) shopCoinsEl.textContent = state.coins; }
  function closeShop(){ shopBackdrop.classList.remove('show'); }

  function renderShop(){
    shopItemsEl.innerHTML = '';
    state.shop.items.forEach(item => {
      const el = document.createElement('div'); el.className = 'shop-item';
      const ownedText = item.consumable ? `Owned: ${item.owned||0}` : (item.owned ? 'Owned' : '');
      el.innerHTML = `<div><div style="font-weight:700;color:var(--text)">${item.name} ${ownedText ? ' ‚Ä¢ '+ownedText : ''}</div><div class="small-muted" style="font-size:13px">${item.desc}</div></div>
        <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
          <div style="font-weight:700;color:var(--gold)">${item.price}G</div>
          <div style="display:flex;gap:6px">
            ${ (!item.owned || item.consumable) ? `<button class="btn small buy-btn" data-id="${item.id}">Buy</button>` : `<button class="btn small equip-btn" data-id="${item.id}">${item.equipped ? 'Equipped' : 'Equip'}</button>` }
            ${ item.consumable && item.owned ? `<button class="btn ghost small use-btn" data-id="${item.id}">Use</button>` : '' }
          </div>
        </div>`;
      shopItemsEl.appendChild(el);

      const buyBtn = el.querySelector('.buy-btn');
      if(buyBtn) buyBtn.addEventListener('click', ()=>{
        if(state.coins < item.price){ alert('üí∏ Gold tidak cukup, petualang!'); return; }
        state.coins -= item.price;
        if(item.consumable) item.owned = (item.owned||0) + 1; else item.owned = true;
        save(); renderHUD(); renderShop(); pushLog(`Bought ${item.name} for ${item.price}G`);
        if(item.effect && !item.consumable) equipItem(item.id);
      });

      const equipBtn = el.querySelector('.equip-btn');
      if(equipBtn) equipBtn.addEventListener('click', ()=> { equipItem(item.id); save(); renderShop(); pushLog(`${item.name} equipped`); });

      const useBtn = el.querySelector('.use-btn');
      if(useBtn) useBtn.addEventListener('click', ()=> { useItem(item.id); save(); renderShop(); pushLog(`${item.name} used`); });
    });
    if(shopCoinsEl) shopCoinsEl.textContent = state.coins;
  }

  function equipItem(id){
    state.shop.items.forEach(it => { if(it.effect) it.equipped = (it.id === id); });
    const it = state.shop.items.find(x=>x.id===id);
    if(it && it.effect){
      document.documentElement.style.setProperty('--accent1', it.effect.accent1);
      document.documentElement.style.setProperty('--accent2', it.effect.accent2);
    }
    save();
  }

  function useItem(id){
    const it = state.shop.items.find(x=>x.id===id);
    if(!it) return;
    if(!it.consumable) return;
    if(!(it.owned && it.owned > 0)) return alert('Tidak punya item ini');
    if(it.id === 'xp-booster'){
      const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1);
      const until = tomorrow.toISOString().slice(0,10);
      state.shop.boosterActiveUntil = until; it.owned = it.owned - 1;
      pushLog('XP Booster activated until '+until); alert('XP Booster aktif untuk hari besok!');
    }
    save();
  }

  function sparkleCoins(amount){
    const el = document.createElement('div'); el.textContent = `+${amount}G`;
    el.style.position = 'fixed';
    const hudRect = document.querySelector('.hud').getBoundingClientRect();
    el.style.left = (hudRect.left + hudRect.width - 160) + 'px';
    el.style.top = (hudRect.top + 8) + 'px';
    el.style.padding = '8px 12px'; el.style.borderRadius = '10px';
    el.style.background = 'linear-gradient(90deg,#fff6e5,#fff3cc)'; el.style.color = '#5a3b00';
    el.style.fontWeight = 800; el.style.boxShadow = 'var(--shadow)'; el.style.zIndex = 9999;
    el.classList.add('coin-pop'); document.body.appendChild(el); setTimeout(()=> el.remove(),900);
  }
  function showCoinLoss(amount){
    const el = document.createElement('div'); el.textContent = `-${amount}G`;
    el.style.position = 'fixed';
    const hudRect = document.querySelector('.hud').getBoundingClientRect();
    el.style.left = (hudRect.left + hudRect.width - 160) + 'px';
    el.style.top = (hudRect.top + 8) + 'px';
    el.style.padding = '8px 12px'; el.style.borderRadius = '10px';
    el.style.background = 'linear-gradient(90deg,#ffe9e9,#ffdede)'; el.style.color = '#7a1b1b';
    el.style.fontWeight = 800; el.style.boxShadow = 'var(--shadow)'; el.style.zIndex = 9999; el.classList.add('coin-loss');
    document.body.appendChild(el); setTimeout(()=> el.remove(),900);
  }

  function showLevelToast(level){
    const t = document.createElement('div');
    t.textContent = `üéâ Level Up! Level ${level} ‚Äî ${LEVEL_NAMES[(level-1)%LEVEL_NAMES.length]}`;
    Object.assign(t.style, { position:'fixed', left:'50%', transform:'translateX(-50%)', top:'22px', padding:'12px 18px', background:'linear-gradient(90deg,var(--accent1),var(--accent2))', borderRadius:'12px', color:'#021', zIndex:9999, fontWeight:800 });
    document.body.appendChild(t); setTimeout(()=> t.remove(),3200);
  }

  function renderAll(){ renderHUD(); renderQuests(); renderLog(); renderChart(); renderShop(); }
  function renderLog(){ recentLog.innerHTML = state.log.slice(0,100).map(l => `<div>${l}</div>`).join(''); }

  function initAfterLoad(){
    state.quests = state.quests.map(q => Object.assign({ xpAwarded: q.xpAwarded || 0, coinsAwarded: q.coinsAwarded || 0 }, q));
    ensureHistoryWindow();
    autoResetCheck();
  }

  load();
  initAfterLoad();
  renderAll();

  setInterval(()=> { renderHUD(); }, 500);

  window._prodRpgDarkV2 = { state, save, renderAll, changeXP };

  window.addEventListener('beforeunload', ()=> save());
})();
</script>
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js')
        .then(registration => {
          console.log('Service Worker registered with scope:', registration.scope);
        })
        .catch(error => {
          console.error('Service Worker registration failed:', error);
        });
    });
  }
</script>
</body>
</html>